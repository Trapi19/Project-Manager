<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <title>Gestor de Proyectos - Unitecnic</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.4.0/css/all.css">
    
    <link rel="stylesheet" href="https://unpkg.com/frappe-gantt/dist/frappe-gantt.css">
    <script src="https://unpkg.com/frappe-gantt/dist/frappe-gantt.umd.js"></script>

    <link rel="stylesheet" href="styles-base.css">
    <link rel="stylesheet" href="styles-print.css" media="print">
    <link rel="stylesheet" href="styles-dashboard.css">
    <link rel="stylesheet" href="styles-states.css">
    <link rel="stylesheet" href="styles-forms.css">
<script>
      (function () {
        try {
          var t = localStorage.getItem('gp_theme') || 'light';
          if (t === 'dark') document.documentElement.classList.add('theme-dark');
        } catch (e) {}
      })();
    </script>
</head>
<body>
    <div id="root"></div>

<script src="app.js"></script>
<script src="assets.js"></script>

<script type="text/babel">
        // --- 3. COMPONENTES REACT (APP PRINCIPAL) ---
        const { useState, useEffect } = React;

        const Icons = {
            check: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>,
            clock: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
            wifi: <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12.55a11 11 0 0 1 14.08 0"/><path d="M1.42 9a16 16 0 0 1 21.16 0"/><path d="M8.53 16.11a6 6 0 0 1 6.95 0"/><line x1="12" y1="20" x2="12.01" y2="20"/></svg>,
            server: <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="2" y="2" width="20" height="8" rx="2" ry="2"/><rect x="2" y="14" width="20" height="8" rx="2" ry="2"/><line x1="6" y1="6" x2="6.01" y2="6"/><line x1="6" y1="18" x2="6.01" y2="18"/></svg>,
            monitor: <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>,
            tv: <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="2" y="7" width="20" height="15" rx="2" ry="2"/><polyline points="17 2 12 7 7 2"/></svg>,
            users: <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>,
            key: <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"></path></svg>,
            alert: <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>,
            lock: <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
        };

        const normalizeDataImage = (value) => {
            if (!value) return "";
            const v = String(value).trim();
            if (!v) return "";
            if (v.startsWith("data:image/")) return v;
            return "data:image/png;base64," + v.replace(/^base64,?/i, "");
        };

        const IconOptions = [
            { id: 'wifi', label: 'Wifi' }, { id: 'server', label: 'Server' }, 
            { id: 'monitor', label: 'Monitor' }, { id: 'tv', label: 'TV' },
            { id: 'users', label: 'Usuarios' }, { id: 'key', label: 'Llave' },
            { id: 'alert', label: 'Alerta' }, { id: 'lock', label: 'Candado' }
        ];

        // --- HELPERS: ESTADOS Y DEPENDENCIAS (PRÓXIMO) ---
        const normalizeEstado = (estado) => estado || 'Pendiente';

        // Normaliza el estado del PROYECTO (meta.estado) para evitar problemas por mayúsculas/minúsculas, tildes, etc.
        const normalizeProjectEstado = (estado) => {
            const raw = (estado ?? 'En Ejecución').toString().trim();
            if (!raw) return 'En Ejecución';
            const low = raw.toLowerCase();

            if (low === 'en ejecucion' || low === 'en ejecución') return 'En Ejecución';
            if (low === 'completado') return 'Completado';
            if (low === 'en pausa') return 'En Pausa';
            if (low === 'en revision' || low === 'en revisión') return 'En Revisión';

            return raw;
        };


        const buildTaskIndex = (tasks) => {
            const idx = new Map();
            tasks.forEach(t => idx.set(t.id, t));
            return idx;
        };

        const isTaskBlocked = (task, taskIndex) => {
            const depId = task.dependsOn;
            if (!depId) return false;
            const dep = taskIndex.get(depId);
            if (!dep) return false; // si no existe, no bloqueamos
            return normalizeEstado(dep.estado) !== 'Completado';
        };

        const effectiveEstado = (task, taskIndex) => {
            const blocked = isTaskBlocked(task, taskIndex);
            const estado = normalizeEstado(task.estado);
            if (blocked) return 'Próximo';
            return estado;
        };

        const computeProjectStats = (tasks) => {
            const idx = buildTaskIndex(tasks);
            const total = tasks.length || 0;
            let completed = 0, inProgress = 0, pending = 0, next = 0;
            tasks.forEach(t => {
                const e = effectiveEstado(t, idx);
                if (e === 'Completado') completed++;
                else if (e === 'En Curso') inProgress++;
                else if (e === 'Pendiente') pending++;
                else if (e === 'Próximo') next++;
                else pending++;
            });
            const progress = total > 0 ? Math.round((completed / total) * 100) : 0;
            return { total, completed, inProgress, pending, next, progress };
        };


        const IconPicker = ({ value, onChange, open, onToggle }) => (
            <div className="relative" onClick={(e) => e.stopPropagation()}>
                <button
                    type="button"
                    onClick={onToggle}
                    className="w-10 h-10 rounded-xl border border-[color:var(--border)] bg-white/80 hover:bg-white flex items-center justify-center text-[color:var(--brand-dark)] shadow-sm focus:outline-none focus:ring-2 focus:ring-[color:var(--brand)]"
                    title="Cambiar icono"
                >
                    {Icons[value] || Icons.monitor}
                </button>
                {open && (
                    <div className="absolute z-50 mt-2 w-56 rounded-2xl border border-[color:var(--border)] bg-white shadow-2xl p-2">
                        <div className="grid grid-cols-4 gap-2">
                            {IconOptions.map(opt => (
                                <button
                                    key={opt.id}
                                    type="button"
                                    onClick={() => onChange(opt.id)}
                                    className={`h-11 rounded-xl border flex items-center justify-center transition-colors ${
                                        opt.id === value
                                            ? "border-[color:rgba(8,136,200,0.35)] bg-[color:rgba(8,136,200,0.10)] text-[color:var(--brand-dark)]"
                                            : "border-slate-100 hover:border-[color:rgba(8,136,200,0.25)] hover:bg-[color:rgba(8,136,200,0.06)] text-slate-700"
                                    }`}
                                    title={opt.label}
                                >
                                    {Icons[opt.id] || Icons.monitor}
                                </button>
                            ))}
                        </div>
                        <div className="mt-2 text-[11px] text-slate-500 px-1">Selecciona un icono</div>
                    </div>
                )}
            </div>
        );


        // --- COMPONENTE: TARJETA DE PROYECTO ---
        const ProjectCard = ({ p, onSelect, onDelete, dnd }) => {
            const {
                onDragStart,
                onDragEnd,
                onDragOver,
                onDrop,
                isDragging,
                isDragOver,
                blockClickRef
            } = dnd || {};
            const stats = computeProjectStats(p.tasks || []);
            const projectEstado = normalizeProjectEstado(p?.meta?.estado);
            const total = stats.total || 1;
            const w = (n) => `${Math.max(0, Math.round((n / total) * 100))}%`;

            return (
                <div
                    data-estado={projectEstado}
                    draggable={!!onDragStart}
                    onDragStart={(e) => { e.stopPropagation(); onDragStart && onDragStart(e, p); }}
                    onDragEnd={(e) => { e.stopPropagation(); onDragEnd && onDragEnd(e); }}
                    onDragOver={(e) => { onDragOver && onDragOver(e, p); }}
                    onDrop={(e) => { onDrop && onDrop(e, p); }}
                    className={`project-card bg-white rounded-xl shadow-sm border border-gray-200 p-6 card-hover transition-all cursor-pointer group relative flex flex-col justify-between ${isDragging ? 'opacity-60' : ''} ${isDragOver ? 'ring-2 ring-[color:rgba(8,136,200,0.35)]' : ''}`}
                    onClick={() => { if (blockClickRef && blockClickRef.current) return; onSelect(p); }}
                >
                    <div>
                        <div className="flex justify-between items-start">
                            <div className={`h-12 w-12 rounded-lg flex items-center justify-center shrink-0 ${
                                    projectEstado === 'Completado' ? 'bg-emerald-100 text-emerald-700'
                                        : projectEstado === 'En Pausa' ? 'bg-slate-100 text-slate-700'
                                        : projectEstado === 'En Revisión' ? 'bg-violet-100 text-violet-700'
                                        : 'bg-[color:rgba(8,136,200,0.12)] text-[color:var(--brand-dark)]'
                                } overflow-hidden`}>
                                {p.meta.clientLogoData ? (
                                    <img src={p.meta.clientLogoData} alt="Logo cliente" className="w-full h-full object-contain p-1" />
                                ) : (
                                    <i className={`fas ${projectEstado === 'Completado' ? 'fa-check-circle' : projectEstado === 'En Pausa' ? 'fa-pause-circle' : projectEstado === 'En Revisión' ? 'fa-search' : 'fa-project-diagram'}`}></i>
                                )}
                            </div>
                            <button 
                                onClick={(e) => { e.stopPropagation(); onDelete(p.id); }}
                                className="text-gray-300 hover:text-red-500 p-2 transition-colors opacity-0 group-hover:opacity-100"
                                title="Eliminar proyecto"
                            >
                                <i className="fas fa-trash"></i>
                            </button>
                        </div>

                        <h3 className="font-bold text-lg text-gray-800 mb-1 truncate">{p.meta.titulo || "Sin Título"}</h3>
                        <p className="text-sm text-gray-500 truncate">{p.meta.subtitulo || "Sin descripción"}</p>
            {p.meta.cliente && (
              <div className="mt-2">
                <span className="apple-chip apple-chip--muted apple-chip--small">
                  <i className="fas fa-building text-[10px]"></i>
                  {p.meta.cliente}
                </span>
              </div>
            )}



            {(p.meta.responsableProyecto || p.meta.pep) && (
              <div className="mt-2 flex flex-wrap gap-2">
                {p.meta.responsableProyecto && (
                  <span className="apple-chip apple-chip--muted">
                    <i className="fas fa-user-gear text-[10px]"></i>
                    {p.meta.responsableProyecto}
                  </span>
                )}
                {p.meta.pep && (
                  <span className="apple-chip apple-chip--muted">
                    <i className="fas fa-hashtag text-[10px]"></i>
                    {p.meta.pep}
                  </span>
                )}
              </div>
            )}

                        {/* Mini-resumen */}
                        <div className="mt-4 space-y-2">
                            <div className="flex items-center justify-between text-xs text-gray-500">
                                <span className="font-semibold text-[color:var(--brand-dark)]">{stats.progress}%</span>
                                <span>{stats.total} tareas</span>
                            </div>

                            {/* Barra apilada */}
                            <div className="w-full h-2 rounded-full bg-gray-100 overflow-hidden flex">
                                <div className="h-full bg-emerald-500" style={{ width: w(stats.completed) }} />
                                <div className="h-full bg-amber-500" style={{ width: w(stats.inProgress) }} />
                                <div className="h-full bg-rose-500" style={{ width: w(stats.pending) }} />
                                <div className="h-full bg-slate-300" style={{ width: w(stats.next) }} />
                            </div>

                            <div className="flex flex-wrap gap-2 text-[11px] text-gray-500">
                                <span className="inline-flex items-center gap-1"><span className="h-2 w-2 rounded-full bg-emerald-500"></span>OK {stats.completed}</span>
                                <span className="inline-flex items-center gap-1"><span className="h-2 w-2 rounded-full bg-amber-500"></span>En curso {stats.inProgress}</span>
                                <span className="inline-flex items-center gap-1"><span className="h-2 w-2 rounded-full bg-rose-500"></span>Pend. {stats.pending}</span>
                                <span className="inline-flex items-center gap-1"><span className="h-2 w-2 rounded-full bg-slate-300"></span>Próx. {stats.next}</span>
                            </div>
                        </div>
                    </div>

                    <div className="mt-6 pt-4 border-t border-gray-100 flex justify-between items-center text-xs text-gray-500">
                        <span className="apple-chip apple-chip--small">{p.tasks.length} Tareas</span>
                        <span className="apple-link">
                            Abrir <i className="fas fa-arrow-right"></i>
                        </span>
                    </div>
                </div>
            );
        };

        // --- COMPONENTE: DASHBOARD ---
        const ProjectList = ({ projects, onCreate, onSelect, onDelete, onMoveProject, onBackup, onImport, theme, onToggleTheme }) => {
            const normClient = (p) => ((p.meta && p.meta.cliente) ? p.meta.cliente : 'Sin cliente').trim() || 'Sin cliente';
            const clients = Array.from(new Set(projects.map(normClient))).sort((a, b) => a.localeCompare(b, 'es'));
            const [clientFilter, setClientFilter] = useState('Todos');
            const [searchTerm, setSearchTerm] = useState('');
            // --- DRAG & DROP (sin librerías externas; compatible con abrir index.html en local) ---
            const [draggingProjectId, setDraggingProjectId] = useState(null);
            const [dragOverProjectId, setDragOverProjectId] = useState(null);
            const blockClickRef = React.useRef(false);
            // --- MENÚ DE ACCIONES (Backup / Importar) ---
            const [actionsOpen, setActionsOpen] = useState(false);
            const actionsRef = React.useRef(null);
            useEffect(() => {
                if (!actionsOpen) return;
                const onDocMouseDown = (e) => {
                    if (actionsRef.current && !actionsRef.current.contains(e.target)) setActionsOpen(false);
                };
                const onKey = (e) => {
                    if (e.key === 'Escape') setActionsOpen(false);
                };
                document.addEventListener('mousedown', onDocMouseDown);
                document.addEventListener('keydown', onKey);
                return () => {
                    document.removeEventListener('mousedown', onDocMouseDown);
                    document.removeEventListener('keydown', onKey);
                };
            }, [actionsOpen]);


            const cleanupProjectDnd = () => {
                setDraggingProjectId(null);
                setDragOverProjectId(null);
                // Permite volver a hacer click inmediatamente después de soltar
                setTimeout(() => { blockClickRef.current = false; }, 0);
            };

            const readDraggedProjectId = (e) => {
                try {
                    return e.dataTransfer.getData('application/x-unitecnic-project') || e.dataTransfer.getData('text/plain');
                } catch (err) {
                    return '';
                }
            };

            const handleProjectDragStart = (e, project) => {
                try {
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('application/x-unitecnic-project', String(project.id));
                    e.dataTransfer.setData('text/plain', String(project.id));
                } catch (err) {}
                blockClickRef.current = true;
                setDraggingProjectId(project.id);
            };

            const handleProjectDragEnd = () => {
                cleanupProjectDnd();
                // Evita que un drag dispare un click "Abrir" al soltar
                setTimeout(() => { blockClickRef.current = false; }, 200);
            };

            const handleProjectCardDragOver = (e, targetProject) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                setDragOverProjectId(targetProject.id);
            };

            const handleProjectCardDrop = (e, targetProject) => {
                e.preventDefault();
                const draggedId = readDraggedProjectId(e);
                if (!draggedId || !onMoveProject) return;
                const targetEstado = normalizeProjectEstado(targetProject?.meta?.estado);
                onMoveProject(draggedId, targetEstado, targetProject.id);
                setDragOverProjectId(null);
                cleanupProjectDnd();
            };

            const handleSectionDragOver = (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
            };

            const handleSectionDrop = (e, targetEstado) => {
                e.preventDefault();
                const draggedId = readDraggedProjectId(e);
                if (!draggedId || !onMoveProject) return;
                onMoveProject(draggedId, targetEstado, null);
                setDragOverProjectId(null);
                cleanupProjectDnd();
            };


            const filteredProjects = projects.filter(p => {
                const matchesClient = clientFilter === 'Todos' || normClient(p) === clientFilter;
                const searchLower = String(searchTerm || '').trim().toLowerCase();
                const matchesSearch = !searchLower || (
                    String(p?.meta?.titulo || '').toLowerCase().includes(searchLower) ||
                    String(p?.meta?.subtitulo || '').toLowerCase().includes(searchLower) ||
                    String(p?.meta?.cliente || '').toLowerCase().includes(searchLower) ||
                    String(p?.meta?.pep || '').toLowerCase().includes(searchLower)
                );
                return matchesClient && matchesSearch;
            });
const activeProjects = filteredProjects.filter(p => normalizeProjectEstado(p?.meta?.estado) === 'En Ejecución');
            const pausedProjects = filteredProjects.filter(p => normalizeProjectEstado(p?.meta?.estado) === 'En Pausa');
            const reviewProjects = filteredProjects.filter(p => normalizeProjectEstado(p?.meta?.estado) === 'En Revisión');
            const completedProjects = filteredProjects.filter(p => normalizeProjectEstado(p?.meta?.estado) === 'Completado');

            // --- RESUMEN EJECUTIVO (CENTRO DE CONTROL) ---
            const nonCompletedProjects = filteredProjects.filter(p => normalizeProjectEstado(p?.meta?.estado) !== 'Completado');

            const executiveSummary = (() => {
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                const parseISO = (iso) => {
                    if (!iso) return null;
                    const t = String(iso).trim();
                    if (!/^\d{4}-\d{2}-\d{2}$/.test(t)) return null;
                    const [y, m, d] = t.split('-').map(n => parseInt(n, 10));
                    return new Date(y, (m || 1) - 1, d || 1);
                };

                const hasOverdueOpenTask = (p) => {
                    const tasks = p?.tasks || [];
                    if (!tasks.length) return false;
                    const idx = buildTaskIndex(tasks);
                    return tasks.some(t => {
                        const lim = parseISO(t?.fechaLimite);
                        if (!lim) return false;
                        const e = effectiveEstado(t, idx);
                        return e !== 'Completado' && lim < today;
                    });
                };

                const hasTooManyPending = (stats) => {
                    if (!stats || (stats.total || 0) < 5) return false;
                    const fracPending = (stats.pending || 0) / Math.max(1, stats.total || 0);
                    return fracPending >= 0.60 && (stats.progress || 0) < 50;
                };

                let tasksTotal = 0;
                let tasksOpen = 0; // Pendientes + En curso
                let tasksCompleted = 0;
                let redProjects = 0;

                nonCompletedProjects.forEach(p => {
                    const stats = computeProjectStats(p?.tasks || []);
                    tasksTotal += stats.total || 0;
                    tasksOpen += (stats.pending || 0) + (stats.inProgress || 0);
                    tasksCompleted += stats.completed || 0;

                    const isRed = hasOverdueOpenTask(p) || hasTooManyPending(stats);
                    if (isRed) redProjects += 1;
                });

                const progressAvg = tasksTotal > 0 ? Math.round((tasksCompleted / tasksTotal) * 100) : 0;

                return {
                    projectsActive: nonCompletedProjects.length,
                    progressAvg,
                    tasksTotal,
                    tasksOpen,
                    redProjects
                };
            })();


            return (
                <div className="max-w-7xl mx-auto p-6 md:p-10">
                    <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-10 gap-4">
                        <div className="flex items-start gap-4">
                            <div className="w-14 h-14 rounded-2xl bg-white/70 border border-gray-200 shadow-sm flex items-center justify-center overflow-hidden shrink-0">
                                <img src={UNITECNIC_LOGO_BASE64} alt="Unitecnic" className="w-full h-full object-contain p-2" />
                            </div>
                            <div>
                                <h1 className="text-3xl font-bold text-gray-900">Dashboard Unitecnic</h1>
                                <p className="text-gray-500 mt-1 flex items-center gap-2"><i className="fas fa-hdd text-orange-500"></i> Modo Personal (Local)</p>

                            <div className="mt-4 flex flex-col sm:flex-row sm:items-center gap-3">
                                <div className="apple-search-wrap">
                                    <i className="fas fa-search apple-search-icon" aria-hidden="true"></i>
                                    <input
                                        type="text"
                                        placeholder="Buscar proyecto..."
                                        value={searchTerm}
                                        onChange={(e) => setSearchTerm(e.target.value)}
                                        onKeyDown={(e) => { if (e.key === 'Escape') setSearchTerm(''); }}
                                        className="apple-search-input"
                                    />
                                </div>

                                <div className="flex items-center gap-2">
                                    <span className="text-[10px] font-bold text-gray-400 uppercase tracking-widest ml-2">Cliente</span>
                                    <select
                                        className="apple-select-filter"
                                        value={clientFilter}
                                        onChange={(e) => setClientFilter(e.target.value)}
                                    >
                                        <option value="Todos">Todos</option>
                                        {clients.map(c => <option key={c} value={c}>{c}</option>)}
                                    </select>
                                </div>
                            </div>
                            </div>

                        </div>
                        <div className="flex items-center gap-2 no-print">
                            <button
                                onClick={onCreate}
                                className="btn-apple-primary no-print"
                                title="Crear nuevo proyecto"
                            >
                                <i className="fas fa-plus"></i>
                                Nuevo
                            </button>

                            <div className="actions-menu no-print" ref={actionsRef}>
                                <button
                                    type="button"
                                    className="btn-apple-icon"
                                    title="Acciones"
                                    aria-label="Acciones"
                                    onClick={() => setActionsOpen(o => !o)}
                                >
                                    <i className="fas fa-ellipsis"></i>
                                </button>

                                {actionsOpen && (
                                    <div className="actions-popover" role="menu" aria-label="Acciones">
                                        <button
                                            type="button"
                                            className="actions-item"
                                            role="menuitem"
                                            onClick={() => { setActionsOpen(false); onBackup(); }}
                                        >
                                            <i className="fas fa-file-arrow-down"></i>
                                            <span>Backup (JSON)</span>
                                        </button>
                                        <button
                                            type="button"
                                            className="actions-item"
                                            role="menuitem"
                                            onClick={() => { setActionsOpen(false); onImport(); }}
                                        >
                                            <i className="fas fa-file-arrow-up"></i>
                                            <span>Importar…</span>
                                        </button>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>

                    {projects.length === 0 ? (
                        <div className="text-center py-24 bg-white rounded-2xl border-2 border-dashed border-gray-200">
                            <div className="text-gray-300 text-6xl mb-6"><i className="fas fa-folder-open"></i></div>
                            <h3 className="text-xl font-semibold text-gray-700">No hay proyectos activos</h3>
                            <p className="text-gray-400 mt-2 mb-6">Gestiona tus instalaciones y mantenimientos desde aquí.</p>
                            <button onClick={onCreate} className="text-blue-600 font-medium hover:underline">Crear primer proyecto</button>
                        </div>
                    ) : (
                        <div className="space-y-12">
                        <div className="section-tapiz exec-summary p-6 rounded-2xl border">
                            <div className="exec-header">
                                <div className="exec-title">
                                    <div className="exec-title-icon" aria-hidden="true">
                                        <i className="fas fa-gauge-high"></i>
                                    </div>
                                    <div>
                                        <div className="exec-title-text">Resumen ejecutivo</div>
                                        <div className="exec-subtitle">Centro de control (según el filtro de cliente)</div>
                                    </div>
                                </div>
                                <div className="exec-pill" title="Se recalcula con los filtros activos">
                                    <i className="fas fa-sliders" aria-hidden="true"></i>
                                    <span>Según filtros</span>
                                </div>
                            </div>

                            <div className="exec-grid">
                                {/* Proyectos activos */}
                                <div className="exec-card">
                                    <div className="exec-card-top">
                                        <div>
                                            <div className="exec-label">Proyectos activos</div>
                                            <div className="exec-value">{executiveSummary.projectsActive}</div>
                                        </div>
                                        <div className="exec-card-icon" aria-hidden="true">
                                            <i className="fas fa-layer-group"></i>
                                        </div>
                                    </div>
                                    <div className="exec-chips">
                                        <span className="px-2 py-1 rounded-full border border-[color:rgba(59,130,246,0.45)] text-blue-700 bg-[color:rgba(59,130,246,0.10)]">
                                            Ejecución: {activeProjects.length}
                                        </span>
                                        <span className="px-2 py-1 rounded-full border border-[color:rgba(239,68,68,0.45)] text-red-700 bg-[color:rgba(239,68,68,0.10)]">
                                            Pausa: {pausedProjects.length}
                                        </span>
                                        <span className="px-2 py-1 rounded-full border border-[color:rgba(139,92,246,0.45)] text-violet-700 bg-[color:rgba(139,92,246,0.10)]">
                                            Revisión: {reviewProjects.length}
                                        </span>
                                    </div>
                                </div>

                                {/* Avance medio */}
                                <div className="exec-card">
                                    <div className="exec-card-top">
                                        <div>
                                            <div className="exec-label">% avance medio</div>
                                            <div className="exec-value">{executiveSummary.progressAvg}%</div>
                                            <div className="exec-note">Ponderado por nº de tareas</div>
                                        </div>
                                        <div className="exec-card-icon" aria-hidden="true">
                                            <i className="fas fa-chart-line"></i>
                                        </div>
                                    </div>
                                    <div className="exec-progress" aria-hidden="true">
                                        <div className="exec-progress-fill" style={{ width: `${executiveSummary.progressAvg}%` }}></div>
                                    </div>
                                </div>

                                {/* Tareas */}
                                <div className="exec-card">
                                    <div className="exec-card-top">
                                        <div>
                                            <div className="exec-label">Tareas</div>
                                            <div className="exec-value">{executiveSummary.tasksTotal}</div>
                                            <div className="exec-note">Abiertas (Pend. + En curso): <span className="font-semibold">{executiveSummary.tasksOpen}</span></div>
                                        </div>
                                        <div className="exec-card-icon" aria-hidden="true">
                                            <i className="fas fa-list-check"></i>
                                        </div>
                                    </div>
                                </div>

                                {/* Bloqueos */}
                                <div className="exec-card">
                                    <div className="exec-card-top">
                                        <div>
                                            <div className="exec-label">Bloqueos</div>
                                            <div className="exec-value">{executiveSummary.redProjects}</div>
                                            <div className="exec-note">En rojo: tareas vencidas o demasiadas pendientes.</div>
                                        </div>
                                        <div className="exec-card-icon exec-card-icon-warn" aria-hidden="true">
                                            <i className="fas fa-triangle-exclamation"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                            {/* SECCIÓN ACTIVA */}
                            <div className="section-tapiz section-estado-ejecucion p-6 rounded-2xl border" data-estado-seccion="En Ejecución" onDragOver={handleSectionDragOver} onDrop={(e) => handleSectionDrop(e, 'En Ejecución')}>
                                <h2 className="text-lg font-bold text-blue-900 mb-6 flex items-center gap-2">
                                    <span className="bg-blue-500 w-2 h-2 rounded-full"></span> En Ejecución
                                    <span className="ml-2 bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full text-xs">{activeProjects.length}</span>
                                </h2>
                                {activeProjects.length > 0 ? (
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                                        {activeProjects.map(p => <ProjectCard
                                                key={p.id}
                                                p={p}
                                                onSelect={onSelect}
                                                onDelete={onDelete}
                                                dnd={{
                                                    onDragStart: handleProjectDragStart,
                                                    onDragEnd: handleProjectDragEnd,
                                                    onDragOver: handleProjectCardDragOver,
                                                    onDrop: handleProjectCardDrop,
                                                    isDragging: draggingProjectId === p.id,
                                                    isDragOver: dragOverProjectId === p.id,
                                                    blockClickRef
                                                }}
                                            />)}
                                    </div>
                                ) : <p className="text-gray-400 text-sm italic">No hay proyectos en curso.</p>}
                            </div>


                            {/* SECCIÓN EN PAUSA */}
                            <div className="section-tapiz section-estado-pausa p-6 rounded-2xl border" data-estado-seccion="En Pausa" onDragOver={handleSectionDragOver} onDrop={(e) => handleSectionDrop(e, 'En Pausa')}>
                                <h2 className="text-lg font-bold text-slate-800 mb-6 flex items-center gap-2">
                                    <span className="bg-slate-500 w-2 h-2 rounded-full"></span> En Pausa
                                    <span className="ml-2 bg-slate-100 text-slate-700 px-2 py-0.5 rounded-full text-xs">{pausedProjects.length}</span>
                                </h2>
                                {pausedProjects.length > 0 ? (
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                                        {pausedProjects.map(p => <ProjectCard
                                                key={p.id}
                                                p={p}
                                                onSelect={onSelect}
                                                onDelete={onDelete}
                                                dnd={{
                                                    onDragStart: handleProjectDragStart,
                                                    onDragEnd: handleProjectDragEnd,
                                                    onDragOver: handleProjectCardDragOver,
                                                    onDrop: handleProjectCardDrop,
                                                    isDragging: draggingProjectId === p.id,
                                                    isDragOver: dragOverProjectId === p.id,
                                                    blockClickRef
                                                }}
                                            />)}
                                    </div>
                                ) : <p className="text-gray-400 text-sm italic">No hay proyectos en pausa.</p>}
                            </div>

                            {/* SECCIÓN EN REVISIÓN */}
                            <div className="section-tapiz section-estado-revision p-6 rounded-2xl border" data-estado-seccion="En Revisión" onDragOver={handleSectionDragOver} onDrop={(e) => handleSectionDrop(e, 'En Revisión')}>
                                <h2 className="text-lg font-bold text-violet-900 mb-6 flex items-center gap-2">
                                    <span className="bg-violet-500 w-2 h-2 rounded-full"></span> En Revisión
                                    <span className="ml-2 bg-violet-100 text-violet-700 px-2 py-0.5 rounded-full text-xs">{reviewProjects.length}</span>
                                </h2>
                                {reviewProjects.length > 0 ? (
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                                        {reviewProjects.map(p => <ProjectCard
                                                key={p.id}
                                                p={p}
                                                onSelect={onSelect}
                                                onDelete={onDelete}
                                                dnd={{
                                                    onDragStart: handleProjectDragStart,
                                                    onDragEnd: handleProjectDragEnd,
                                                    onDragOver: handleProjectCardDragOver,
                                                    onDrop: handleProjectCardDrop,
                                                    isDragging: draggingProjectId === p.id,
                                                    isDragOver: dragOverProjectId === p.id,
                                                    blockClickRef
                                                }}
                                            />)}
                                    </div>
                                ) : <p className="text-gray-400 text-sm italic">No hay proyectos en revisión.</p>}
                            </div>

                            {/* SECCIÓN COMPLETADOS */}
                            {completedProjects.length > 0 && (
                                
<div className="section-tapiz section-estado-completado p-6 rounded-2xl border" data-estado-seccion="Completado" onDragOver={handleSectionDragOver} onDrop={(e) => handleSectionDrop(e, 'Completado')}>
                                    <h2 className="text-lg font-bold text-gray-700 mb-6 flex items-center gap-2 opacity-75">
                                        <span className="bg-green-500 w-2 h-2 rounded-full"></span> Histórico / Completados
                                    </h2>
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 opacity-75 hover:opacity-100 transition-opacity">
                                        {completedProjects.map(p => <ProjectCard
                                                key={p.id}
                                                p={p}
                                                onSelect={onSelect}
                                                onDelete={onDelete}
                                                dnd={{
                                                    onDragStart: handleProjectDragStart,
                                                    onDragEnd: handleProjectDragEnd,
                                                    onDragOver: handleProjectCardDragOver,
                                                    onDrop: handleProjectCardDrop,
                                                    isDragging: draggingProjectId === p.id,
                                                    isDragOver: dragOverProjectId === p.id,
                                                    blockClickRef
                                                }}
                                            />)}
                                    </div>
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        };

        // --- COMPONENTE: VISTA PREVIA (Read Only) ---
        const ProjectPreview = ({ data }) => {
            const totalTasks = data.tasks.length;
            const completedTasks = data.tasks.filter(t => t.estado === 'Completado').length;
            const progress = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
            
            const getStatusColor = (status) => {
            switch(status) {
                case 'Completado': return 'status-completed';
                case 'Pendiente': return 'status-pending';
                case 'En Curso': return 'status-inprogress';
                case 'Próximo': return 'status-next';
                default: return 'status-default';
            }
        };

            const taskIndex = buildTaskIndex(data.tasks);

            const getDependencyLabel = (task) => {
                if (!task.dependsOn) return null;
                const dep = taskIndex.get(task.dependsOn);
                if (!dep) return 'Dependencia no encontrada';
                return `${dep.area} - ${dep.tarea}`;
            };


            return (
                <div className="bg-gray-50 print-container">
                    <div className="max-w-7xl mx-auto space-y-6">
                        {/* Cabecera Vista Previa */}
                        <div id="header-container" className="print-header flex flex-col md:flex-row justify-between items-start md:items-center bg-white p-8 rounded-xl shadow-sm border border-gray-200">
                            <div className="header-left-part flex items-center w-full md:w-2/3 gap-4 md:gap-6">
                                {data.meta.clientLogoData && <img src={normalizeDataImage(data.meta.clientLogoData)} alt="Logo Cliente" className="h-14 w-auto object-contain shrink-0 logo-print" />}
                                <div>
                                    <h1 className="text-3xl font-bold text-gray-900 leading-tight tracking-tight">{data.meta.titulo}</h1>
                                    <p className="text-gray-500 mt-2 text-lg">{data.meta.subtitulo}</p>
                                </div>
                            </div>
                            <div className="header-right-part mt-4 md:mt-0 flex items-center gap-6 self-start md:self-center">
                                <div className="hidden md:block w-px h-12 bg-gray-200 no-print"></div>
                                {/* Logo Unitecnic siempre presente */}
                                <img src={UNITECNIC_LOGO_BASE64} alt="Unitecnic" className="h-10 md:h-12 object-contain logo-print" />
                            </div>
                        </div>

                        {/* Stats Vista Previa (también se imprime en PDF) */}
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                                <div className="flex items-center justify-between gap-4">
                                    <div className="min-w-0">
                                        <p className="text-sm font-medium text-gray-500">Estado Global</p>
                                        <p className="text-3xl font-bold text-gray-900 mt-2 tabular-nums">{progress}%</p>
                                        <p className="text-xs text-gray-400 mt-1">Completado</p>
                                    </div>

                                    {/* Donut de progreso */}
                                    <div className="shrink-0">
                                        <svg width="64" height="64" viewBox="0 0 64 64" className="block">
                                            {/* Anillo base */}
                                            <circle cx="32" cy="32" r="26" fill="none" stroke="var(--progress-track)" strokeWidth="8" />
                                            {/* Progreso */}
                                            <circle
                                                cx="32"
                                                cy="32"
                                                r="26"
                                                fill="none"
                                                stroke="#2563EB"
                                                strokeWidth="8"
                                                strokeLinecap="round"
                                                transform="rotate(-90 32 32)"
                                                strokeDasharray={2 * Math.PI * 26}
                                                strokeDashoffset={(2 * Math.PI * 26) * (1 - (progress / 100))}
                                            />
                                            {/* Texto central */}
                                            <text x="32" y="36" textAnchor="middle" fontSize="14" fontWeight="700" fill="var(--progress-text)" className="tabular-nums">
                                                {progress}%
                                            </text>
                                        </svg>
                                    </div>
                                </div>
</div>
                            <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                                <div className="flex items-center justify-between">
                                    <div><p className="text-sm font-medium text-gray-500">Tareas Resueltas</p><p className="text-3xl font-bold text-green-600 mt-2">{completedTasks}</p></div>
                                    <div className="w-12 h-12 flex items-center justify-center bg-green-50 rounded-full text-green-600"><i className="fas fa-check"></i></div>
                                </div>
                            </div>
                            <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                                <div className="flex items-center justify-between">
                                    <div><p className="text-sm font-medium text-gray-500">Pendientes</p><p className="text-3xl font-bold text-orange-600 mt-2">{totalTasks - completedTasks}</p></div>
                                    <div className="w-12 h-12 flex items-center justify-center bg-orange-50 rounded-full text-orange-600"><i className="fas fa-clock"></i></div>
                                </div>
                            </div>
                        </div>

                        {/* Tabla Vista Previa */}
                        <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                            <div className="px-6 py-4 border-b border-gray-200 bg-gray-50"><h2 className="text-lg font-semibold text-gray-800">Detalle de Trabajos</h2></div>
                            <div className="w-full">
                                <table className="w-full table-fixed text-left border-collapse text-sm">
                                    <thead>
                                        <tr className="bg-gray-50 text-gray-500 text-xs uppercase tracking-wider">
                                            <th className="px-4 py-3 font-medium whitespace-normal break-words w-1/5">Área</th>
                                            <th className="px-4 py-3 font-medium whitespace-normal break-words w-1/4">Tarea</th>
                                            <th className="px-4 py-3 font-medium whitespace-normal break-words w-1/6">Estado</th>
                                            <th className="px-4 py-3 font-medium whitespace-normal break-words w-1/4">Detalles</th>
                                            <th className="px-4 py-3 font-medium whitespace-normal break-words w-1/6">Inicio</th>
                                        <th className="px-4 py-3 font-medium whitespace-normal break-words w-1/6">Límite</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-gray-200">
                                        {data.tasks.map((row) => (
                                            <tr key={row.id} className="hover:bg-gray-50 transition-colors">
                                                <td className="px-4 py-3 align-top whitespace-normal break-words">
                                                    <div className="flex items-center">
                                                        <div className="p-1.5 bg-gray-100 rounded-lg mr-2 text-gray-600 no-print">{Icons[row.iconType] || Icons.monitor}</div>
                                                        <span className="font-medium text-gray-900">{row.area}</span>
                                                    </div>
                                                </td>
                                                <td className="px-4 py-3 align-top whitespace-normal break-words">
                                                    <div className="flex flex-col gap-1">
                                                        <span className="text-gray-700 font-medium">{row.tarea}</span>
                                                        {isTaskBlocked(row, taskIndex) && (
                                                            <span className="inline-flex items-center gap-2 text-xs px-2 py-1 rounded-full bg-slate-100 text-slate-700 border border-slate-200 w-fit dependency-pill">
                                                                <i className="fas fa-lock"></i>
                                                                Bloqueada por: <span className="font-medium">{getDependencyLabel(row) || '—'}</span>
                                                            </span>
                                                        )}
                                                    </div>
                                                </td>
                                                <td className="px-4 py-3 align-top whitespace-normal break-words"><span className={`status-pill px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full border ${getStatusColor(row.estado)}`}>{row.estado}</span></td>
                                                <td className="px-4 py-3 align-top whitespace-normal break-words"><span className="text-sm text-gray-600">{row.detalles ?? ''}</span></td>
                                                <td className="px-4 py-3 align-top whitespace-normal break-words"><span className={`text-sm ${(row.fechaLimite || '').includes('Dic') || (row.fechaLimite || '').includes('Urgente') ? 'text-red-600 font-medium' : 'text-gray-500'}`}>{window.formatFechaES(row.fechaInicio)}</span></td>
                                            <td className="px-4 py-3 align-top whitespace-normal break-words"><span className={`text-sm ${(row.fechaLimite || '').includes('Dic') || (row.fechaLimite || '').includes('Urgente') ? 'text-red-600 font-medium' : 'text-gray-500'}`}>{window.formatFechaES(row.fechaLimite)}</span></td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- COMPONENTE: EDITOR DE PROYECTO ---
        const ProjectEditor = ({ project, onSave, onBack, onCancelNew, isSaving, theme, onToggleTheme }) => {
            const [data, setData] = useState(project);
            const [hasChanges, setHasChanges] = useState(false);
            const taskIndex = React.useMemo(() => buildTaskIndex(data.tasks || []), [data.tasks]);
            const [viewMode, setViewMode] = useState(project && project.__isDraft ? 'edit' : 'preview'); 
            const [showExportMenu, setShowExportMenu] = useState(false);
            const [showToast, setShowToast] = useState(false);
            const [openIconPickerId, setOpenIconPickerId] = useState(null);
            // --- DRAG & DROP de tareas (reordenación) ---
            const [draggingTaskId, setDraggingTaskId] = useState(null);
            const [dragOverTaskId, setDragOverTaskId] = useState(null);

            const readDraggedTaskId = (e) => {
                try {
                    return e.dataTransfer.getData('application/x-unitecnic-task') || e.dataTransfer.getData('text/plain');
                } catch (err) {
                    return '';
                }
            };

            const reorderTasks = (dragId, beforeId) => {
                setData(prev => {
                    const tasks = [...(prev.tasks || [])];
                    const fromIdx = tasks.findIndex(t => String(t.id) === String(dragId));
                    if (fromIdx < 0) return prev;

                    const [moving] = tasks.splice(fromIdx, 1);

                    let toIdx = tasks.length;
                    if (beforeId) {
                        const bi = tasks.findIndex(t => String(t.id) === String(beforeId));
                        if (bi >= 0) toIdx = bi;
                    }
                    tasks.splice(toIdx, 0, moving);
                    return { ...prev, tasks };
                });
                setHasChanges(true);
            };

            const handleTaskDragStart = (e, taskId) => {
                try {
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('application/x-unitecnic-task', String(taskId));
                    e.dataTransfer.setData('text/plain', String(taskId));
                } catch (err) {}
                setDraggingTaskId(taskId);
            };

            const handleTaskDragEnd = () => {
                setDraggingTaskId(null);
                setDragOverTaskId(null);
            };

            const handleTaskRowDragOver = (e, targetTaskId) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                setDragOverTaskId(targetTaskId);
            };

            const handleTaskRowDrop = (e, targetTaskId) => {
                e.preventDefault();
                const draggedId = readDraggedTaskId(e);
                if (!draggedId) return;
                if (String(draggedId) === String(targetTaskId)) return;
                reorderTasks(draggedId, targetTaskId);
                setDragOverTaskId(null);
                setDraggingTaskId(null);
                setDragOverTaskId(null);
            };

            const handleTaskTableDrop = (e) => {
                e.preventDefault();
                const draggedId = readDraggedTaskId(e);
                if (!draggedId) return;
                reorderTasks(draggedId, null);
                setDragOverTaskId(null);
                setDraggingTaskId(null);
                setDragOverTaskId(null);
            };

            const handleTaskTableDragOver = (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
            };


            const [showGantt, setShowGantt] = useState(false);
            const [ganttWarnings, setGanttWarnings] = useState([]);
            const ganttRef = React.useRef(null);

            const parseISODate = (s) => {
                if (!s) return null;
                const t = String(s).trim();
                if (!/^\d{4}-\d{2}-\d{2}$/.test(t)) return null;
                const d = new Date(t + "T00:00:00");
                return isNaN(d.getTime()) ? null : d;
            };

            const fmtISO = (d) => {
                const yyyy = d.getFullYear();
                const mm = String(d.getMonth() + 1).padStart(2, "0");
                const dd = String(d.getDate()).padStart(2, "0");
                return `${yyyy}-${mm}-${dd}`;
            };
            // Formato de fecha ES: usa window.formatFechaES() global


            const addDays = (d, n) => {
                const x = new Date(d);
                x.setDate(x.getDate() + n);
                return x;
            };

            const makeGanttTasks = (projectData) => {
                // Fuente única de verdad: projectData.tasks (lo mismo que pinta la tabla)
                const tasks = (projectData?.tasks || []);
                const idx = new Map(tasks.map(t => [t.id, t]));

                const warnings = [];
                const isCompleted = (t) => String(t?.estado || "").toLowerCase().includes("complet");

                const result = [];

                for (const t of tasks) {
                    // Fechas reales (si existen). Si faltan, inferimos lo mínimo para que Gantt renderice.
                    let start = parseISODate(t.fechaInicio);
                    let end = parseISODate(t.fechaLimite);

                    if (!start && end) start = addDays(end, -1);
                    if (!end && start) end = addDays(start, 1);
                    if (!start && !end) {
                        // Sin fechas: lo situamos hoy+1 para que sea visible y avisamos.
                        const today = new Date();
                        start = today;
                        end = addDays(today, 1);
                        warnings.push(`La tarea "${t.tarea}" no tiene fechas (Inicio/Límite). Se muestra temporalmente en Hoy.`);
                    }

                    if (start && end && start > end) {
                        warnings.push(`Revisa fechas: "${t.tarea}" tiene Inicio (${fmtISO(start)}) posterior a Límite (${fmtISO(end)}).`);
                    }

                    // Estado -> progreso y color (mismo criterio que UI)
                    const estado = String(t.estado || "").toLowerCase();
                    let progress = estado.includes("complet") ? 100 : estado.includes("curso") ? 50 : 0;
                    let customClass =
                        estado.includes("complet") ? "bar-completed"
                      : estado.includes("curso") ? "bar-in-progress"
                      : (estado.includes("próximo") || estado.includes("proximo")) ? "bar-upcoming"
                      : "bar-pending";

                    // Dependencias: si existe dependsOn y la tarea dependiente NO está completada, marcamos como bloqueada
                    // Nota: NO condicionamos a la fecha de fin (eso era lo que desincronizaba Gantt vs tabla).
                    let isBlocked = false;
                    if (t.dependsOn) {
                        const dep = idx.get(t.dependsOn);
                        if (!dep) {
                            isBlocked = true;
                            warnings.push(`La tarea "${t.tarea}" tiene una dependencia inexistente (ID ${t.dependsOn}).`);
                        } else if (!isCompleted(dep)) {
                            isBlocked = true;
                            warnings.push(`La tarea "${t.tarea}" se muestra como Bloqueada por "${dep.area} - ${dep.tarea}" hasta que esté Completada.`);
                        }
                    }

                    // Si el propio estado contiene "bloque", también lo tratamos como bloqueada
                    if (estado.includes("bloque")) isBlocked = true;

                    let name = `${t.area || ""} · ${t.tarea || ""}`.trim();
                    if (isBlocked) {
                        progress = 0;
                        customClass = "bar-blocked";
                        name = `🔒 ${name}`;
                    }

                    result.push({
                        id: String(t.id),
                        name,
                        start: fmtISO(start),
                        end: fmtISO(end),
                        progress,
                        dependencies: t.dependsOn ? String(t.dependsOn) : "",
                        custom_class: customClass
                    });
                }

                return { tasks: result, warnings };
            };

            useEffect(() => {
                if (!showGantt) return;
                if (!ganttRef.current) return;

                ganttRef.current.innerHTML = "";
                const built = makeGanttTasks(data);
                const gt = built.tasks || [];
                setGanttWarnings(built.warnings || []);
                if (!gt.length) return;

                new Gantt(ganttRef.current, gt, {
                    view_mode: "Day",
                    language: "es"
                });
            }, [showGantt, data]);

            const toDateInputValue = (v) => {
                const s = (v ?? '').toString().trim();
                return /^\d{4}-\d{2}-\d{2}$/.test(s) ? s : '';
            };


            useEffect(() => {
                const onDocClick = () => { if (openIconPickerId !== null) setOpenIconPickerId(null); };
                document.addEventListener('click', onDocClick);
                return () => document.removeEventListener('click', onDocClick);
            }, [openIconPickerId]);


            const isNewDraft = Boolean(project && project.__isDraft);

            const handleCancelNew = () => {
                // Confirmación para evitar perder cambios
                if (isNewDraft) {
                    const touched = hasChanges || (data?.tasks?.length || 0) > 0 ||
                        (data?.meta?.titulo && data.meta.titulo !== 'Nuevo Proyecto') ||
                        (data?.meta?.cliente && data.meta.cliente !== 'Sin cliente') ||
                        (data?.meta?.subtitulo && data.meta.subtitulo !== 'Informe de Inicio') ||
                        (data?.meta?.responsableProyecto) ||
                        (data?.meta?.pep);
                    if (touched) {
                        const ok = confirm('Se descartará el nuevo proyecto y se perderán los cambios. ¿Continuar?');
                        if (!ok) return;
                    }
                    onCancelNew && onCancelNew();
                    return;
                }
                onBack && onBack();
            };

            const handleBack = () => {
                // Para nuevos, tratamos "volver" como cancelar (con confirmación)
                if (isNewDraft) return handleCancelNew();
                onBack && onBack();
            };

            const handleSave = async () => { 
                const res = await onSave(data); 
                setHasChanges(false);

                // Si era un nuevo proyecto, onSave ya nos ha llevado al dashboard y el componente se desmontará
                if (res && res.created) return;

                setViewMode('preview');
                setShowToast(true);
                setTimeout(() => setShowToast(false), 3000);
            };

            const updateMeta = (field, value) => { setData(prev => ({ ...prev, meta: { ...prev.meta, [field]: value } })); setHasChanges(true); };

            // --- Logos de cliente (persistentes en localStorage) ---
            const getClientLogoMap = () => {
                try { return JSON.parse(localStorage.getItem('clientLogoMap') || '{}'); }
                catch { return {}; }
            };
            const setClientLogoMap = (next) => {
                try { localStorage.setItem('clientLogoMap', JSON.stringify(next || {})); }
                catch {}
            };

            const handleClienteChange = (value) => {
                const v = (value || '').trim();
                updateMeta('cliente', value);

                // Si el proyecto aún no tiene logo, y existe uno guardado para ese cliente, lo aplica automáticamente.
                const hasLogo = !!(data.meta.clientLogoData && String(data.meta.clientLogoData).trim());
                if (!hasLogo && v) {
                    const map = getClientLogoMap();
                    if (map[v]) updateMeta('clientLogoData', map[v]);
                }
            };

            const handleClientLogoUpload = (file) => {
                if (!file) return;
                if (!file.type || !file.type.startsWith('image/')) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    const dataUrl = e.target?.result;
                    if (!dataUrl) return;

                    updateMeta('clientLogoData', dataUrl);

                    const cliente = (data.meta.cliente || '').trim();
                    if (cliente) {
                        const map = getClientLogoMap();
                        map[cliente] = dataUrl;   // guarda para reutilizar en futuros proyectos
                        setClientLogoMap(map);
                    }
                };
                reader.readAsDataURL(file);
            };

            const handleClientLogoRemove = () => {
                updateMeta('clientLogoData', '');
                // Nota: no borramos el mapa global para no perder logos reutilizables.
            };

            const updateTask = (id, field, value) => { 
                setData(prev => {
                    const nextTasks = prev.tasks.map(t => {
                        if (t.id !== id) return t;
                        const updated = { ...t, [field]: value };

                        if (field === 'dependsOn') {
                            const idx = buildTaskIndex(prev.tasks);
                            const blocked = isTaskBlocked(updated, idx);
                            if (blocked) updated.estado = 'Próximo';
                        }
                        return updated;
                    });
                    return { ...prev, tasks: nextTasks };
                });
                setHasChanges(true); 
            };
            const addTask = () => { setData(prev => ({ ...prev, tasks: [...prev.tasks, { id: Date.now(), area: "Nueva Área", tarea: "Nueva Tarea", estado: "Pendiente", detalles: "Descripción...", fechaInicio: "", fechaLimite: "", iconType: "monitor", dependsOn: null }] })); setHasChanges(true); };
            const deleteTask = (id) => { if(confirm('¿Borrar tarea?')) { setData(prev => ({ ...prev, tasks: prev.tasks.filter(t => t.id !== id) })); setHasChanges(true); }};

            // EXPORTACIONES
            const exportHTML = () => {
                const dataJson = JSON.stringify(data, null, 4);
                // Inyectamos el template
                const finalHTML = getClientTemplate(dataJson);
                const blob = new Blob([finalHTML], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.href = url;
                link.download = `${data.meta.titulo.replace(/\s+/g, '_')}_ENTREGABLE.html`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                setShowExportMenu(false);
            };

            const exportCSV = () => {
                const headers = ["Area;Tarea;Estado;Detalles;Fecha Inicio;Fecha Limite"];
                const rows = data.tasks.map(item => `"${item.area}";"${item.tarea}";"${item.estado}";"${item.detalles}";"${item.fechaInicio ?? ""}";"${item.fechaLimite ?? ""}"`);
                const csvContent = "\uFEFF" + [headers, ...rows].join("\n");
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.href = url;
                link.download = `${data.meta.titulo.replace(/\s+/g, '_')}.csv`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                setShowExportMenu(false);
            };

            const printPDF = () => {
                setViewMode('preview');
                setShowExportMenu(false);
                setTimeout(() => window.print(), 500);
            };

            return (
                <div className="min-h-screen bg-gray-50 pb-20 relative">

                    {showGantt && (
                        <div className="fixed inset-0 z-50 bg-black/40 flex items-center justify-center p-4 no-print" onClick={() => { setShowGantt(false); setGanttWarnings([]); }}>
                            <div className="bg-white w-full max-w-6xl rounded-2xl shadow-2xl border border-gray-200 overflow-hidden" onClick={(e) => e.stopPropagation()}>
                                <div className="px-5 py-4 border-b flex items-center justify-between">
                                    <div className="min-w-0">
                                        <div className="text-sm text-gray-500">Gantt del proyecto</div>
                                        <div className="font-semibold text-gray-900 truncate">{data?.meta?.titulo || "Sin título"}</div>
                                    </div>
                                    <button onClick={() => { setShowGantt(false); setGanttWarnings([]); }} className="px-3 py-2 rounded-lg bg-gray-100 hover:bg-gray-200 text-gray-700 text-sm">
                                        Cerrar
                                    </button>
                                </div>

                                <div className="p-4">
                                    {ganttWarnings.length > 0 && (
                                        <div className="mb-4 rounded-xl border border-amber-200 bg-amber-50 p-3 text-sm text-amber-900">
                                            <div className="font-semibold mb-1">Avisos de planificación</div>
                                            <ul className="list-disc pl-5 space-y-1">
                                                {ganttWarnings.slice(0, 12).map((w, i) => (<li key={i}>{w}</li>))}
                                            </ul>
                                            {ganttWarnings.length > 12 && (
                                                <div className="mt-2 text-xs text-amber-800">Se muestran 12 avisos. Corrige dependencias/fechas para eliminar el resto.</div>
                                            )}
                                        </div>
                                    )}
                                    {(data?.tasks || []).length === 0 ? (
                                        <div className="text-sm text-gray-500">No hay tareas en este proyecto.</div>
                                    ) : (
                                        <div ref={ganttRef} className="w-full overflow-auto"></div>
                                    )}
                                    <div className="mt-3 text-xs text-gray-400">
                                        Nota: el Gantt se genera a partir de las mismas tareas que la tabla (<b>fechaInicio</b> / <b>fechaLimite</b> y dependencias).
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* NOTIFICACIÓN TOAST */}
                    {showToast && (
                        <div className="fixed top-[calc(env(safe-area-inset-top)+16px)] left-1/2 -translate-x-1/2 bg-gray-900/80 text-white px-5 py-3 rounded-2xl shadow-xl backdrop-blur-md border border-white/10 flex items-center gap-3 z-50 z-[9999] pointer-events-none">
                            <div className="bg-green-500 rounded-full p-1"><i className="fas fa-check text-white text-xs"></i></div>
                            <div><h4 className="font-bold text-sm">Guardado</h4><p className="text-xs text-gray-400">Listo para exportar.</p></div>
                        </div>
                    )}

                    <div className="bg-white border-b border-gray-200 sticky top-0 z-20 px-6 py-3 flex justify-between items-center shadow-sm no-print">
                        <div className="flex items-center gap-4">
                          <button onClick={handleBack} className="text-gray-500 hover:text-gray-800 flex items-center gap-2 text-sm font-medium">
                                <i className="fas fa-arrow-left"></i> <span className="hidden sm:inline">Dashboard</span>
                            </button>
                            <div className="h-6 w-px bg-gray-200"></div>
                            
                            {/* Botón de cambio de vista */}
                            <button
                                onClick={() => setViewMode(viewMode === 'edit' ? 'preview' : 'edit')}
                                className={`px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2 transition-colors ${
                                    viewMode === 'edit'
                                        ? 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                                        : 'bg-blue-600 text-white hover:bg-blue-700'
                                }`}
                                title={viewMode === 'edit' ? 'Ver vista previa' : 'Editar proyecto'}
                            >
                                <i className={`fas ${viewMode === 'edit' ? 'fa-eye' : 'fa-pen'}`}></i>
                                <span className="hidden sm:inline">{viewMode === 'edit' ? 'Vista previa' : 'Editar proyecto'}</span>
                            </button>
                        </div>

                        <div className="flex gap-3 relative">
                            {isNewDraft && (
                            <button
                                onClick={handleCancelNew}
                                className="px-4 py-2 rounded-lg text-sm font-medium bg-slate-800 hover:bg-slate-700 text-white/90 border border-white/10 transition"
                                title="Descartar el nuevo proyecto"
                            >
                                Cancelar
                            </button>
                        )}

                        <button onClick={handleSave} disabled={isSaving} className={`px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2 ${hasChanges ? 'bg-blue-600 text-white hover:bg-blue-700' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}>
                                {isSaving ? <i className="fas fa-circle-notch fa-spin"></i> : <i className="fas fa-save"></i>}
                                <span className="hidden sm:inline">{isSaving ? 'Guardando...' : 'Guardar Progreso'}</span>
                            </button>

                            {/* Dropdown Exportar */}
                            <button
                                onClick={() => setShowGantt(true)}
                                className="px-4 py-2 bg-slate-800 hover:bg-slate-900 text-white rounded-lg text-sm font-medium flex items-center gap-2 shadow-sm"
                                title="Ver Gantt del proyecto"
                            >
                                <i className="fas fa-diagram-project"></i>
                                <span className="hidden sm:inline">Gantt</span>
                            </button>

                            <div className="relative">
                                <button onClick={() => setShowExportMenu(!showExportMenu)} className="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg text-sm font-medium flex items-center gap-2 shadow-sm">
                                    <i className="fas fa-share-square"></i> <span className="hidden sm:inline">Exportar</span> <i className="fas fa-chevron-down text-xs"></i>
                                </button>
                                
                                {showExportMenu && (
                                    <div className="absolute right-0 mt-2 w-56 bg-white rounded-lg shadow-xl border border-gray-100 z-50 overflow-hidden">
                                        <button onClick={exportHTML} className="w-full text-left px-4 py-3 hover:bg-purple-50 text-sm text-gray-700 flex items-center gap-3 border-b border-gray-50">
                                            <div className="w-8 h-8 rounded-full bg-purple-100 text-purple-600 flex items-center justify-center"><i className="fas fa-code"></i></div>
                                            <div><p className="font-medium">Web Cliente (HTML)</p><p className="text-xs text-gray-400">Sólo lectura, incluye logo</p></div>
                                        </button>
                                        <button onClick={exportCSV} className="w-full text-left px-4 py-3 hover:bg-green-50 text-sm text-gray-700 flex items-center gap-3 border-b border-gray-50">
                                            <div className="w-8 h-8 rounded-full bg-green-100 text-green-600 flex items-center justify-center"><i className="fas fa-file-csv"></i></div>
                                            <div><p className="font-medium">Excel (CSV)</p><p className="text-xs text-gray-400">Para hojas de cálculo</p></div>
                                        </button>
                                        <button onClick={printPDF} className="w-full text-left px-4 py-3 hover:bg-red-50 text-sm text-gray-700 flex items-center gap-3">
                                            <div className="w-8 h-8 rounded-full bg-red-100 text-red-600 flex items-center justify-center"><i className="fas fa-file-pdf"></i></div>
                                            <div><p className="font-medium">PDF Oficial</p><p className="text-xs text-gray-400">Impresión optimizada</p></div>
                                        </button>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>

                    {/* Contenido Principal */}
                    {viewMode === 'preview' ? (
                        <div className="py-8">
                            <ProjectPreview data={data} />
                        </div>
                    ) : (
                        <div className="max-w-6xl mx-auto mt-8 px-6 space-y-8">
                            {/* Panel de Configuración */}
                            <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                                <div className="flex justify-between items-center mb-6 pb-2 border-b">
                                    <h3 className="text-sm font-bold text-gray-500 uppercase tracking-wider">Datos del Proyecto</h3>
                                    <span className="text-xs text-gray-400">ID: {data.id}</span>
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                                    <div className="space-y-4">
                                        <div>
                                            <label className="block text-xs font-semibold text-gray-600 uppercase mb-1">Título</label>
                                            <input type="text" className="w-full border border-gray-300 p-2.5 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-shadow" value={data.meta.titulo} onChange={(e) => updateMeta('titulo', e.target.value)} placeholder="Ej: Renovación Sede Central" />
                                        </div>
                                        <div>
                                            <label className="block text-xs font-semibold text-gray-600 uppercase mb-1">Subtítulo / Fase</label>
                                            <input type="text" className="w-full border border-gray-300 p-2.5 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-shadow" value={data.meta.subtitulo} onChange={(e) => updateMeta('subtitulo', e.target.value)} placeholder="Ej: Fase 1 - Cableado Estructurado" />
                                        </div>
                                        
                                        <div>
                                            <label className="block text-xs font-semibold text-gray-600 uppercase mb-1">Cliente</label>
                                            <input
                                                type="text"
                                                className="w-full border border-gray-300 p-2.5 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-shadow"
                                                value={data.meta.cliente || ''}
                                                onChange={(e) => handleClienteChange(e.target.value)}
                                                placeholder="Ej: RTVE / EITB / Mediaset..."
                                            />
                                        </div>


                                        <div>
                                            <label className="block text-xs font-semibold text-gray-600 uppercase mb-1">Responsable de Proyecto</label>
                                            <input
                                                type="text"
                                                className="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-shadow"
                                                value={data.meta.responsableProyecto || ''}
                                                onChange={(e) => updateMeta('responsableProyecto', e.target.value)}
                                                placeholder="Ej: Daniel Avilés"
                                            />
                                        </div>

                                        <div>
                                            <label className="block text-xs font-semibold text-gray-600 uppercase mb-1">PEP</label>
                                            <input
                                                type="text"
                                                className="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-shadow"
                                                value={data.meta.pep || ''}
                                                onChange={(e) => updateMeta('pep', e.target.value)}
                                                placeholder="Ej: PEP-2026-001"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-xs font-semibold text-gray-600 uppercase mb-1">Logo del cliente</label>
                                            <div className="flex items-center gap-3">
                                                <div className="h-12 w-12 rounded-lg bg-slate-100 border border-slate-200 flex items-center justify-center overflow-hidden">
                                                    {data.meta.clientLogoData ? (
                                                        <img src={data.meta.clientLogoData} alt="Logo cliente" className="w-full h-full object-contain p-1" />
                                                    ) : (
                                                        <i className="fas fa-image text-slate-400"></i>
                                                    )}
                                                </div>

                                                <div className="flex items-center gap-2">
                                                    <label className="inline-flex items-center gap-2 px-3 py-2 rounded-lg bg-white border border-gray-200 hover:bg-gray-50 cursor-pointer text-sm font-semibold text-gray-700 transition">
                                                        <i className="fas fa-upload"></i>
                                                        Subir logo
                                                        <input
                                                            type="file"
                                                            accept="image/*"
                                                            className="hidden"
                                                            onChange={(e) => handleClientLogoUpload(e.target.files?.[0])}
                                                        />
                                                    </label>

                                                    {data.meta.clientLogoData && (
                                                        <button
                                                            type="button"
                                                            className="inline-flex items-center gap-2 px-3 py-2 rounded-lg bg-white border border-gray-200 hover:bg-gray-50 text-sm font-semibold text-gray-700 transition"
                                                            onClick={handleClientLogoRemove}
                                                            title="Quitar logo"
                                                        >
                                                            <i className="fas fa-trash"></i>
                                                            Quitar
                                                        </button>
                                                    )}
                                                </div>
                                            </div>
                                            <p className="text-xs text-gray-500 mt-2">
                                                Consejo: al subir un logo se guarda para este cliente y se aplicará automáticamente en futuros proyectos cuando escribas el mismo nombre de cliente.
                                            </p>
                                        </div>
<div>
                                            <label className="block text-xs font-semibold text-gray-600 uppercase mb-1">Estado</label>
                                            <select 
                                                className="w-full border border-gray-300 p-2.5 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none bg-white"
                                                value={normalizeProjectEstado(data.meta.estado)}
                                                onChange={(e) => updateMeta('estado', e.target.value)}
                                            >
                                                <option value="En Ejecución">⚡ En Ejecución (Activo)</option>
                                                <option value="En Pausa">⏸ En Pausa</option>
                                                <option value="En Revisión">🔎 En Revisión</option>
                                                <option value="Completado">✅ Completado (Histórico)</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div className="space-y-4">
                                        
                                    </div>
                                </div>
                            </div>

                            {/* Editor de Tareas */}
                            <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                                <div className="px-6 py-4 border-b border-gray-200 bg-gray-50 flex justify-between items-center">
                                    <h2 className="font-semibold text-gray-800">Plan de Trabajo</h2>
                                    <button onClick={addTask} className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2 transition-colors shadow-sm">
                                        <i className="fas fa-plus"></i> Nueva Tarea
                                    </button>
                                </div>
                                
                                <div className="overflow-x-auto">
                                    <table className="w-full min-w-[1200px] text-left border-collapse">
                                        <thead>
                                            <tr className="bg-gray-50 text-gray-500 text-xs uppercase tracking-wider border-b border-gray-200">
                                                <th className="px-6 py-3 font-semibold whitespace-nowrap min-w-[320px]">ÁREA / TIPO</th>
                                                <th className="px-6 py-3 font-semibold whitespace-nowrap min-w-[280px]">TAREA</th>
                                                <th className="px-6 py-3 font-semibold whitespace-nowrap min-w-[160px]">ESTADO</th>
                                                <th className="px-6 py-3 font-semibold whitespace-nowrap min-w-[280px]">DETALLES</th>
                                                <th className="px-6 py-3 font-semibold whitespace-nowrap min-w-[180px]">FECHA INICIO</th>
                                                <th className="px-6 py-3 font-semibold whitespace-nowrap min-w-[180px]">FECHA LÍMITE</th>
                                                <th className="px-4 py-3 font-semibold text-center w-10"></th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-gray-100 bg-white" onDragOver={handleTaskTableDragOver} onDrop={handleTaskTableDrop}>
                                            {data.tasks.map((task, idx) => (
                                                <tr
                                                key={task.id}
                                                onDragOver={(e) => handleTaskRowDragOver(e, task.id)}
                                                onDrop={(e) => handleTaskRowDrop(e, task.id)}
                                                className={`hover:bg-blue-50/30 transition-colors align-top group ${dragOverTaskId === task.id ? 'ring-2 ring-[color:rgba(8,136,200,0.25)]' : ''} ${draggingTaskId === task.id ? 'opacity-60' : ''}`}
                                            >
                                                    <td className="px-6 py-4 min-w-[320px]">
                                                        <div className="flex flex-col gap-2">
                                                            <div className="flex items-center gap-2">
                                                                <span
                                                                    draggable
                                                                    onDragStart={(e) => handleTaskDragStart(e, task.id)}
                                                                    onDragEnd={handleTaskDragEnd}
                                                                    className="task-drag-handle inline-flex items-center justify-center w-8 h-8 rounded-lg border border-gray-200 bg-white text-gray-400 hover:text-gray-700 hover:border-gray-300 cursor-grab active:cursor-grabbing"
                                                                    title="Arrastra para reordenar"
                                                                >
                                                                    <i className="fas fa-grip-vertical"></i>
                                                                </span>
                                                                <IconPicker
                                                                    value={task.iconType}
                                                                    open={openIconPickerId === task.id}
                                                                    onToggle={() => setOpenIconPickerId(prev => prev === task.id ? null : task.id)}
                                                                    onChange={(newId) => { updateTask(task.id, 'iconType', newId); setOpenIconPickerId(null); }}
                                                                />
                                                                <input 
                                                                    type="text" 
                                                                    className="flex-1 border border-gray-200 rounded text-sm p-1.5 focus:ring-1 focus:ring-blue-500 outline-none font-medium" 
                                                                    value={task.area} 
                                                                    onChange={(e) => updateTask(task.id, 'area', e.target.value)} 
                                                                />
                                                            
                                                                <div className="flex flex-wrap items-center gap-2 pl-12 min-w-0">
                                                                    <div className="text-[11px] text-gray-500 shrink-0">Depende de</div>
                                                                    <select
                                                                        className="flex-1 min-w-[240px] border border-gray-200 rounded-lg px-2 py-1 text-xs bg-white focus:outline-none focus:ring-1 focus:ring-[color:var(--brand)]"
                                                                        value={task.dependsOn || ''}
                                                                        onChange={(e) => updateTask(task.id, 'dependsOn', e.target.value ? Number(e.target.value) : null)}
                                                                    >
                                                                        <option value="">(ninguna)</option>
                                                                        {data.tasks
                                                                            .filter(t => t.id !== task.id)
                                                                            .map(t => (
                                                                                <option key={t.id} value={t.id}>
                                                                                    {`${t.area || ''} - ${t.tarea || ''}`.slice(0, 60)}
                                                                                </option>
                                                                            ))}
                                                                    </select>
                                                                    {isTaskBlocked(task, taskIndex) && (
                                                                        <span className="inline-flex items-center gap-1 text-[11px] px-2 py-1 rounded-full bg-slate-100 text-slate-600 border border-slate-200" title="Bloqueada: la tarea previa no está completada">
                                                                            <i className="fas fa-lock"></i> Bloqueada
                                                                        </span>
                                                                    )}
                                                                </div>
</div>
                                                        </div>
                                                    </td>
                                                    <td className="px-6 py-4 min-w-[280px]">
                                                        <textarea 
                                                            rows="2"
                                                            className="w-full border border-gray-200 rounded text-sm p-2 focus:ring-1 focus:ring-blue-500 outline-none resize-none bg-transparent w-full" 
                                                            value={task.tarea} 
                                                            onChange={(e) => updateTask(task.id, 'tarea', e.target.value)} 
                                                        />
                                                    </td>
                                                    <td className="px-6 py-4 min-w-[160px]">
                                                        <select 
                                                            className={`w-full border rounded text-sm p-1.5 outline-none font-medium ${task.estado === 'Completado' ? 'bg-emerald-50 text-emerald-700 border-emerald-200'
                                                                    : task.estado === 'En Curso' ? 'bg-amber-50 text-amber-700 border-amber-200'
                                                                    : task.estado === 'Próximo' ? 'bg-slate-50 text-slate-700 border-slate-200'
                                                                    : 'bg-rose-50 text-rose-700 border-rose-200'}`}
                                                            value={task.estado} 
                                                            onChange={(e) => {
                                                                    const newEstado = e.target.value;
                                                                    const blocked = isTaskBlocked(task, taskIndex);
                                                                    if (blocked && (newEstado === 'Pendiente' || newEstado === 'En Curso')) {
                                                                        alert('Esta tarea está bloqueada por una dependencia. Marca la tarea previa como Completado para poder iniciarla.');
                                                                        updateTask(task.id, 'estado', 'Próximo');
                                                                        return;
                                                                    }
                                                                    updateTask(task.id, 'estado', newEstado);
                                                                }}
                                                        >
                                                            <option value="Pendiente">Pendiente</option>
                                                            <option value="En Curso">En Curso</option>
                                                            <option value="Completado">Completado</option>
                                                                <option value="Próximo">Próximo</option>
                                                        </select>
                                                    </td>
                                                    <td className="px-6 py-4 min-w-[280px]">
                                                        <textarea 
                                                            rows="2" 
                                                            className="w-full border border-gray-200 rounded text-xs p-2 focus:ring-1 focus:ring-blue-500 outline-none resize-y text-gray-600" 
                                                            value={task.detalles} 
                                                            onChange={(e) => updateTask(task.id, 'detalles', e.target.value)} 
                                                            placeholder="Añadir notas..."
                                                        ></textarea>
                                                    </td>
                                                    <td className="px-6 py-4 min-w-[180px]">
                                                        <input 
                                                            type="date" 
                                                            className="w-full border border-gray-200 rounded text-sm p-1.5 focus:ring-1 focus:ring-blue-500 outline-none text-center" 
                                                            value={toDateInputValue(task.fechaInicio)} 
                                                            onChange={(e) => updateTask(task.id, 'fechaInicio', e.target.value)} 
                                                        />
                                                    </td>
<td className="px-6 py-4 min-w-[180px]">
                                                        <input 
                                                            type="date" 
                                                            className="w-full border border-gray-200 rounded text-sm p-1.5 focus:ring-1 focus:ring-blue-500 outline-none text-center" 
                                                            value={toDateInputValue(task.fechaLimite)} 
                                                            onChange={(e) => updateTask(task.id, 'fechaLimite', e.target.value)} 
                                                        />
                                                    </td>
                                                    <td className="px-4 py-4 text-center align-middle">
                                                        <button 
                                                            onClick={() => deleteTask(task.id)} 
                                                            className="text-gray-300 hover:text-red-500 p-2 rounded transition-colors opacity-0 group-hover:opacity-100"
                                                            title="Eliminar"
                                                        >
                                                            <i className="fas fa-times"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- APP PRINCIPAL ---
        const MainApp = () => {
            const [theme, setTheme] = React.useState(() => localStorage.getItem('gp_theme') || 'light');
            React.useEffect(() => {
                document.documentElement.classList.toggle('theme-dark', theme === 'dark');
                localStorage.setItem('gp_theme', theme);
            }, [theme]);
            const toggleTheme = () => setTheme(t => (t === 'dark' ? 'light' : 'dark'));



            const [view, setView] = useState('loading');
            const [projects, setProjects] = useState([]);
            const [currentProject, setCurrentProject] = useState(null);
            const [isSaving, setIsSaving] = useState(false);

            const [backupToast, setBackupToast] = useState(false);
            const [projectToast, setProjectToast] = useState(false);

            const [importToast, setImportToast] = useState(false);
            const [importCandidate, setImportCandidate] = useState(null);
            const [importConfirmOpen, setImportConfirmOpen] = useState(false);
            const importFileInputRef = React.useRef(null);


            const exportBackupJSON = () => {
                try {
                    const logoMap = (() => {
                        try { return JSON.parse(localStorage.getItem('clientLogoMap') || '{}'); }
                        catch (e) { return {}; }
                    })();

                    const payload = {
                        app: "Gestor de Proyectos Unitecnic",
                        schemaVersion: 1,
                        exportedAt: new Date().toISOString(),
                        projects: projects || [],
                        clientLogoMap: logoMap
                    };

                    const jsonStr = JSON.stringify(payload, null, 2);
                    const blob = new Blob([jsonStr], { type: "application/json;charset=utf-8" });
                    const url = URL.createObjectURL(blob);

                    const pad = (n) => String(n).padStart(2, '0');
                    const d = new Date();
                    const filename = `backup_gestor_${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}_${pad(d.getHours())}${pad(d.getMinutes())}.json`;

                    const a = document.createElement("a");
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    setTimeout(() => URL.revokeObjectURL(url), 5000);

                    setBackupToast(true);
                    setTimeout(() => setBackupToast(false), 2600);
                } catch (e) {
                    console.error(e);
                    alert("No se pudo generar el backup.");
                }
            };

            
            // --- IMPORTAR BACKUP (.json) ---
            const openImportPicker = () => {
                if (importFileInputRef.current) importFileInputRef.current.click();
            };

            const normalizeImportPayload = (data) => {
                // Acepta payloads con estructura esperada o variantes sencillas
                if (!data || typeof data !== 'object') return null;
                const projects = Array.isArray(data.projects) ? data.projects : (Array.isArray(data.unitecnic_projects) ? data.unitecnic_projects : null);
                const logoMap = (data.clientLogoMap && typeof data.clientLogoMap === 'object') ? data.clientLogoMap : (data.client_logo_map && typeof data.client_logo_map === 'object' ? data.client_logo_map : {});
                if (!projects) return null;
                return { projects, clientLogoMap: logoMap, meta: { exportedAt: data.exportedAt, schemaVersion: data.schemaVersion, app: data.app } };
            };

            const handleImportFileSelected = (e) => {
                try {
                    const file = e.target.files && e.target.files[0];
                    // Permitir seleccionar el mismo fichero dos veces seguidas
                    e.target.value = '';
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = () => {
                        try {
                            const raw = JSON.parse(String(reader.result || ''));
                            const normalized = normalizeImportPayload(raw);
                            if (!normalized) {
                                alert("El archivo no parece un backup válido de este gestor.");
                                return;
                            }
                            setImportCandidate(normalized);
                            setImportConfirmOpen(true);
                        } catch (err) {
                            console.error(err);
                            alert("No se pudo leer el JSON. ¿Está corrupto?");
                        }
                    };
                    reader.onerror = () => {
                        alert("No se pudo leer el archivo.");
                    };
                    reader.readAsText(file);
                } catch (err) {
                    console.error(err);
                    alert("No se pudo iniciar la importación.");
                }
            };

            const confirmImport = () => {
                if (!importCandidate) return;
                try {
                    localStorage.setItem('unitecnic_projects', JSON.stringify(importCandidate.projects || []));
                    localStorage.setItem('clientLogoMap', JSON.stringify(importCandidate.clientLogoMap || {}));

                    // Refrescar estado en memoria
                    setProjects(importCandidate.projects || []);
                    setCurrentProject(null);
                    setView('list');

                    setImportConfirmOpen(false);
                    setImportCandidate(null);

                    setImportToast(true);
                    setTimeout(() => setImportToast(false), 2600);
                } catch (err) {
                    console.error(err);
                    alert("No se pudo importar el backup.");
                }
            };

const loadProjectsLocal = () => {
                const saved = localStorage.getItem('unitecnic_projects');
                return saved ? JSON.parse(saved) : [];
            };

            const saveProjectsLocal = (newProjectsList) => {
                localStorage.setItem('unitecnic_projects', JSON.stringify(newProjectsList));
                setProjects(newProjectsList);
            };

            useEffect(() => {
                setProjects(loadProjectsLocal());
                setView('list');
            }, []);

                        const createProject = async () => {
                            const draftProject = {
                                id: 'draft_' + Date.now(),
                                __isDraft: true,
                                meta: { 
                                    titulo: "Nuevo Proyecto", 
                                    subtitulo: "Informe de Inicio", 
                                    cliente: "Sin cliente", 
                                    clientLogoData: "", 
                                    empresa: "UNITECNIC", 
                                    estado: "En Ejecución", 
                                    responsableProyecto: "",
                                    pep: "" 
                                },
                                tasks: []
                            };

                            setCurrentProject(draftProject);
                            setView('editor');
                        };

            const selectProject = (p) => {
                setCurrentProject(p);
                setView('editor');
            };

                        const saveProject = async (updatedData) => {
                            setIsSaving(true);
                            try {
                                const clean = { ...updatedData };
                                if (clean.__isDraft) delete clean.__isDraft;

                                const isNew = String(updatedData?.id || '').startsWith('draft_') || !projects.some(p => p.id === updatedData.id);

                                if (isNew) {
                                    const created = { ...clean, id: 'local_' + Date.now() };
                                    const updatedList = [...projects, created];
                                    saveProjectsLocal(updatedList);

                                    // Volvemos al dashboard al crear (flujo "Nuevo → Editar → Guardar → Dashboard")
                                    setCurrentProject(null);
                                    setView('list');

                                    setProjectToast(true);
                                    setTimeout(() => setProjectToast(false), 2600);

                                    await new Promise(r => setTimeout(r, 450)); // UX
                                    return { created: true, project: created };
                                } else {
                                    const updatedList = projects.map(p => p.id === clean.id ? clean : p);
                                    saveProjectsLocal(updatedList);
                                    setCurrentProject(clean);
                                    await new Promise(r => setTimeout(r, 450)); // UX
                                    return { created: false, project: clean };
                                }
                            } catch (e) {
                                console.error(e);
                                alert('Error al guardar');
                                return { created: false, project: null, error: true };
                            } finally {
                                setIsSaving(false);
                            }
                        };

                        const deleteProject = async (id) => {
                            if(!confirm("¿Eliminar proyecto permanentemente?")) return;
                            const updatedList = projects.filter(p => p.id !== id);
                            saveProjectsLocal(updatedList);
                        };


            const moveProject = (projectId, targetEstado, beforeProjectId) => {
                const target = normalizeProjectEstado(targetEstado);
                const draggedId = String(projectId);
                const beforeId = beforeProjectId ? String(beforeProjectId) : null;

                const currentList = [...projects];
                const fromIdx = currentList.findIndex(p => String(p.id) === draggedId);
                if (fromIdx < 0) return;

                const moving = {
                    ...currentList[fromIdx],
                    meta: { ...(currentList[fromIdx].meta || {}), estado: target }
                };

                currentList.splice(fromIdx, 1);

                let insertIdx = currentList.length;

                if (beforeId) {
                    const bi = currentList.findIndex(p => String(p.id) === beforeId);
                    if (bi >= 0) insertIdx = bi;
                } else {
                    // Inserta al final del bloque del mismo estado (mantiene orden por estados)
                    const sameStateIdx = currentList
                        .map((p, i) => ({ i, estado: normalizeProjectEstado(p?.meta?.estado) }))
                        .filter(x => x.estado === target)
                        .map(x => x.i);

                    if (sameStateIdx.length) insertIdx = Math.max(...sameStateIdx) + 1;
                }

                currentList.splice(insertIdx, 0, moving);
                saveProjectsLocal(currentList);
            };

if (view === 'loading') return <div className="h-screen flex items-center justify-center bg-gray-50"><div className="loader"></div></div>;

            return (
                <div>
                    {/* Importar backup (.json) */}
                    <input
                        ref={importFileInputRef}
                        type="file"
                        accept="application/json,.json"
                        className="hidden"
                        onChange={handleImportFileSelected}
                    />

                    {view === 'list' && (
                        <ProjectList 
                            projects={projects} 
                            onCreate={createProject} 
                            onSelect={selectProject}
                            onDelete={deleteProject}
                            onMoveProject={moveProject}
                            onBackup={exportBackupJSON}
                            onImport={openImportPicker}
                        theme={theme}
                            onToggleTheme={toggleTheme}
                        />
                    )}
                    {view === 'editor' && currentProject && (
                        <ProjectEditor 
                            project={currentProject} 
                            onSave={saveProject} 
                            onBack={() => { setCurrentProject(null); setView('list'); }}
                            onCancelNew={() => { setCurrentProject(null); setView('list'); }}
                            isSaving={isSaving}
                            theme={theme}
                            onToggleTheme={toggleTheme}
                        />
                    )}
                
                    
                    {/* Toast: Backup generado (estilo Apple) */}
                    
                    {/* Confirmación de importación (sobrescribe datos actuales) */}
                    {importConfirmOpen && importCandidate && (
                        <div className="modal-overlay no-print" role="dialog" aria-modal="true" aria-label="Confirmar importación">
                            <div className="modal-card">
                                <div className="modal-title">Importar backup</div>
                                <div className="modal-subtitle">
                                    Esta acción sobrescribe los datos actuales para evitar duplicados.
                                </div>

                                <div className="modal-meta">
                                    <div><span className="modal-meta-label">Proyectos:</span> {Array.isArray(importCandidate.projects) ? importCandidate.projects.length : 0}</div>
                                    <div><span className="modal-meta-label">Logos:</span> {importCandidate.clientLogoMap ? Object.keys(importCandidate.clientLogoMap).length : 0}</div>
                                    {importCandidate.meta && importCandidate.meta.exportedAt && (
                                        <div><span className="modal-meta-label">Backup:</span> {new Date(importCandidate.meta.exportedAt).toLocaleString('es-ES')}</div>
                                    )}
                                </div>

                                <div className="modal-actions">
                                    <button
                                        type="button"
                                        className="btn-apple"
                                        onClick={() => { setImportConfirmOpen(false); setImportCandidate(null); }}
                                    >
                                        Cancelar
                                    </button>
                                    <button
                                        type="button"
                                        className="btn-apple-danger"
                                        onClick={confirmImport}
                                    >
                                        Importar y sobrescribir
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {importToast && (
                        <div className="fixed top-[calc(env(safe-area-inset-top)+16px)] left-1/2 -translate-x-1/2 bg-black/60 backdrop-blur-xl border border-white/10 rounded-2xl px-4 py-3 flex items-center gap-3 z-[9999] pointer-events-none no-print">
                            <div className="h-10 w-10 rounded-full bg-white/10 flex items-center justify-center">
                                <i className="fas fa-file-arrow-up"></i>
                            </div>
                            <div className="min-w-[220px]">
                                <div className="font-semibold leading-tight">Importación completada</div>
                                <div className="text-xs text-white/70">Datos restaurados (proyectos y logos).</div>
                            </div>
                        </div>
                    )}



{projectToast && (
                        <div className="fixed top-[calc(env(safe-area-inset-top)+18px)] left-1/2 -translate-x-1/2 bg-black/60 text-white px-5 py-3 rounded-2xl shadow-2xl backdrop-blur-md border border-white/10 flex items-center gap-3 z-[9999] pointer-events-none">
                            <div className="bg-green-500 rounded-full p-1"><i className="fas fa-check text-white"></i></div>
                            <div>
                                <div className="font-semibold leading-tight">Proyecto creado</div>
                                <div className="text-sm text-white/75 leading-tight">Guardado y añadido al Dashboard.</div>
                            </div>
                        </div>
                    )}

{backupToast && (
                        <div className="fixed top-[calc(env(safe-area-inset-top)+16px)] left-1/2 -translate-x-1/2 bg-gray-900/80 text-white px-5 py-3 rounded-2xl shadow-xl backdrop-blur-md border border-white/10 flex items-center gap-3 z-[9999] pointer-events-none no-print">
                            <div className="h-10 w-10 rounded-full bg-white/10 flex items-center justify-center">
                                <i className="fas fa-file-arrow-down"></i>
                            </div>
                            <div>
                                <div className="font-semibold leading-tight">Backup generado</div>
                                <div className="text-xs text-white/70">Archivo .json descargado con proyectos y logos.</div>
                            </div>
                        </div>
                    )}

                    {/* Botón flotante de tema (Sol/Luna) */}
                    <button
                        type="button"
                        onClick={toggleTheme}
                        className={`theme-fab no-print ${theme === 'dark' ? 'night' : 'day'}`}
                        title={theme === 'dark' ? 'Cambiar a modo día' : 'Cambiar a modo noche'}
                        aria-label={theme === 'dark' ? 'Cambiar a modo día' : 'Cambiar a modo noche'}
                    >
                        {theme === 'dark' ? (
                            <i className="fas fa-moon"></i>
                        ) : (
                            <i className="fas fa-sun"></i>
                        )}
                    </button>
</div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<MainApp />);
    </script>
</body>
</html>