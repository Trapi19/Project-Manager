<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <title>Gestor de Proyectos - Unitecnic</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.4.0/css/all.css">
    
    <link rel="stylesheet" href="https://unpkg.com/frappe-gantt/dist/frappe-gantt.css">
    <script src="https://unpkg.com/frappe-gantt/dist/frappe-gantt.umd.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/aws-amplify/6.0.5/aws-amplify.min.js"></script>

    <link rel="stylesheet" href="styles-base.css">
    <link rel="stylesheet" href="styles-print.css" media="print">
    <link rel="stylesheet" href="styles-dashboard.css">
    <link rel="stylesheet" href="styles-states.css">
    <link rel="stylesheet" href="styles-forms.css">

    <style>
        #login-gate {
            position: fixed; inset: 0; background: #f1f5f9; 
            display: flex; align-items: center; justify-content: center; z-index: 10000;
            transition: background 0.3s ease;
        }
        .login-box {
            background: white; padding: 40px; border-radius: 24px; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.1); width: 100%; max-width: 420px; text-align: center;
            transition: all 0.3s ease;
        }
        .auth-input {
            width: 100% !important; height: 44px !important; padding: 0 15px !important;
            background-color: #f8fafc !important; border: 1px solid #e2e8f0 !important;
            border-radius: 12px !important; font-size: 14px !important;
            color: #111 !important; outline: none !important; margin-top: 5px;
            background-image: none !important;
        }
        .login-label {
            display: block; text-align: left; font-size: 11px; font-weight: 700; 
            color: #94a3b8; text-transform: uppercase; margin-bottom: 2px;
        }
        .login-btn {
            width: 100%; padding: 14px; background: #0888C8; color: white; 
            border-radius: 12px; font-weight: 700; border: none; margin-top: 20px; 
            cursor: pointer; transition: all 0.2s;
        }
        .login-btn:hover { background: #0672a8; transform: translateY(-1px); }
        .toggle-link { color: #0888C8; font-weight: 600; cursor: pointer; text-decoration: underline; }

        /* MODO OSCURO */
        .theme-dark #login-gate { background: #0b1220; }
        .theme-dark .login-box { background: #111827; border: 1px solid rgba(255,255,255,0.1); }
        .theme-dark .auth-input { 
            background-color: rgba(255,255,255,0.05) !important; 
            border-color: rgba(255,255,255,0.1) !important; 
            color: white !important; 
        }
        .theme-dark h2 { color: white !important; }
        .theme-dark p { color: #9ca3af !important; }
    </style>

    <script>
      (function () {
        try {
          var t = localStorage.getItem('gp_theme') || 'light';
          if (t === 'dark') document.documentElement.classList.add('theme-dark');
        } catch (e) {}
      })();
    </script>
</head>
<body>
    <div id="root" style="display: none;"></div>

    <div id="login-gate">
        <div class="login-box">
            
            <div id="view-login">
                <h2 style="font-weight: 800; font-size: 22px; margin-bottom: 5px;">Acceso Unitecnic</h2>
                <p style="font-size: 14px; margin-bottom: 25px;">Introduce tus credenciales</p>
                <div style="margin-bottom: 15px;">
                    <label class="login-label">Email</label>
                    <input type="email" id="l-email" class="auth-input" placeholder="usuario@unitecnic.com">
                </div>
                <div>
                    <label class="login-label">Contraseña</label>
                    <input type="password" id="l-pass" class="auth-input" placeholder="••••••••">
                </div>
                <button onclick="handleLogin()" class="login-btn">Entrar al Gestor</button>
                <p style="margin-top: 20px; font-size: 13px;">
                    ¿No tienes cuenta? <span class="toggle-link" onclick="switchView('view-signup')">Regístrate aquí</span>
                </p>
            </div>

            <div id="view-signup" style="display: none;">
                <h2 style="font-weight: 800; font-size: 22px; margin-bottom: 5px;">Crear Cuenta</h2>
                <p style="font-size: 14px; margin-bottom: 25px;">Solo correos @unitecnic.com</p>
                <div style="margin-bottom: 15px;">
                    <label class="login-label">Email corporativo</label>
                    <input type="email" id="s-email" class="auth-input" placeholder="nombre@unitecnic.com">
                </div>
                <div>
                    <label class="login-label">Nueva Contraseña</label>
                    <input type="password" id="s-pass" class="auth-input" placeholder="Mínimo 8 caracteres">
                </div>
                <button onclick="handleSignUp()" class="login-btn">Crear cuenta</button>
                <p style="margin-top: 20px; font-size: 13px;">
                    ¿Ya tienes cuenta? <span class="toggle-link" onclick="switchView('view-login')">Inicia sesión</span>
                </p>
            </div>

            <div id="view-verify" style="display: none;">
                <h2 style="font-weight: 800; font-size: 22px; margin-bottom: 5px;">Verifica tu correo</h2>
                <p style="font-size: 14px; margin-bottom: 25px;">Hemos enviado un código a tu email</p>
                <div>
                    <label class="login-label">Código de verificación</label>
                    <input type="text" id="v-code" class="auth-input" placeholder="000000">
                </div>
                <button onclick="handleVerify()" class="login-btn">Confirmar registro</button>
            </div>

            <p id="msg-error" style="color: #ef4444; font-size: 12px; margin-top: 15px; display: none; background: rgba(239, 68, 68, 0.1); padding: 10px; border-radius: 8px;"></p>
        </div>
    </div>

    <script src="app.js?v=7"></script>
    <script src="assets.js?v=7"></script>
    <script src="app.bundle.js?v=7"></script>

    <script>
        const { Auth } = window.Amplify;
        let tempEmail = ""; 

        function switchView(viewId) {
            document.getElementById('view-login').style.display = 'none';
            document.getElementById('view-signup').style.display = 'none';
            document.getElementById('view-verify').style.display = 'none';
            document.getElementById('msg-error').style.display = 'none';
            document.getElementById(viewId).style.display = 'block';
        }

        function showError(text) {
            const err = document.getElementById('msg-error');
            err.innerText = text;
            err.style.display = 'block';
        }

        async function handleLogin() {
            const email = document.getElementById('l-email').value;
            const pass = document.getElementById('l-pass').value;
            try {
                await window.Amplify.Auth.signIn({ username: email, password: pass });
                document.getElementById('login-gate').style.display = 'none';
                document.getElementById('root').style.display = 'block';
            } catch (err) {
                if(err.name === "UserNotConfirmedException") {
                    tempEmail = email;
                    switchView('view-verify');
                    showError("Tu cuenta no está confirmada. Introduce el código enviado a tu email.");
                } else {
                    showError("Error: Usuario o contraseña incorrectos.");
                }
            }
        }

        async function handleSignUp() {
            const email = document.getElementById('s-email').value;
            const pass = document.getElementById('s-pass').value;
            if(!email.endsWith('@unitecnic.com')) return showError("Solo se permiten correos @unitecnic.com");
            try {
                await window.Amplify.Auth.signUp({ username: email, password: pass, options: { userAttributes: { email } } });
                tempEmail = email;
                switchView('view-verify');
            } catch (err) {
                showError("No se pudo crear la cuenta: " + err.message);
            }
        }

        async function handleVerify() {
            const code = document.getElementById('v-code').value;
            try {
                await window.Amplify.Auth.confirmSignUp({ username: tempEmail, confirmationCode: code });
                switchView('view-login');
                alert("¡Cuenta verificada! Ya puedes iniciar sesión.");
            } catch (err) {
                showError("Código incorrecto: " + err.message);
            }
        }

        window.onload = async () => {
            try {
                await Auth.getCurrentUser();
                document.getElementById('login-gate').style.display = 'none';
                document.getElementById('root').style.display = 'block';
            } catch (e) {}
        };
    </script>
</body>
</html>